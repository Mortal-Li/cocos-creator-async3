"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.onAssetMenu = void 0;
const fs_extra_1 = require("fs-extra");
const TargetFilter = ["cc.ImageAsset", "cc.SpriteAtlas", "cc.AnimationClip", "cc.Material"];
const SearchFilter = ["cc.SceneAsset", "cc.Prefab"];
let uuid2BuffMap = new Map();
let isSearching = false;
/**
 * 不能定义为async，否则不生效
 */
function onAssetMenu(assetInfo) {
    if (!assetInfo.isDirectory)
        return [];
    return [
        {
            label: "🔍未被引用的资源",
            async click() {
                if (isSearching) {
                    console.log("搜索中，请稍等...");
                    return;
                }
                isSearching = true;
                Editor.Selection.clear('asset');
                console.log("开始搜索 >>>");
                uuid2BuffMap.clear();
                let infos = await Editor.Message.request('asset-db', 'query-assets');
                let results = [];
                for (let i = 0; i < infos.length; ++i) {
                    let cur = infos[i];
                    if (TargetFilter.includes(cur.type) && cur.url.startsWith(assetInfo.url)) {
                        let hasFind = false;
                        for (let j = 0; j < infos.length; ++j) {
                            let one = infos[j];
                            if (SearchFilter.includes(one.type)) {
                                let content = uuid2BuffMap.get(one.uuid);
                                if (!content) {
                                    content = (0, fs_extra_1.readFileSync)(one.file, 'utf-8');
                                    uuid2BuffMap.set(one.uuid, content);
                                }
                                if (content.includes(cur.uuid)) {
                                    hasFind = true;
                                    break;
                                }
                            }
                        }
                        if (!hasFind) {
                            results.push(cur);
                        }
                    }
                }
                console.log("搜索结束 <<<");
                console.log(`有${results.length}个资源未被引用:`);
                for (let i = 0; i < results.length; ++i) {
                    console.log(`${i + 1}、${results[i].url}`);
                    Editor.Selection.select('asset', results[i].uuid);
                }
                isSearching = false;
            }
        }
    ];
}
exports.onAssetMenu = onAssetMenu;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXRzLW1lbnUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zb3VyY2UvYXNzZXRzLW1lbnUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsdUNBQXdDO0FBRXhDLE1BQU0sWUFBWSxHQUFHLENBQUMsZUFBZSxFQUFFLGdCQUFnQixFQUFFLGtCQUFrQixFQUFFLGFBQWEsQ0FBQyxDQUFDO0FBQzVGLE1BQU0sWUFBWSxHQUFHLENBQUMsZUFBZSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBRXBELElBQUksWUFBWSxHQUF3QixJQUFJLEdBQUcsRUFBRSxDQUFDO0FBQ2xELElBQUksV0FBVyxHQUFHLEtBQUssQ0FBQztBQUN4Qjs7R0FFRztBQUNILFNBQWdCLFdBQVcsQ0FBQyxTQUFvQjtJQUM1QyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVc7UUFBRSxPQUFPLEVBQUUsQ0FBQztJQUV0QyxPQUFPO1FBQ0g7WUFDSSxLQUFLLEVBQUUsV0FBVztZQUNsQixLQUFLLENBQUMsS0FBSztnQkFDUCxJQUFJLFdBQVcsRUFBRSxDQUFDO29CQUNkLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7b0JBQzFCLE9BQU87Z0JBQ1gsQ0FBQztnQkFDRCxXQUFXLEdBQUcsSUFBSSxDQUFDO2dCQUNuQixNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDaEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFFeEIsWUFBWSxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNyQixJQUFJLEtBQUssR0FBRyxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxjQUFjLENBQUMsQ0FBQztnQkFDckUsSUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFDO2dCQUNqQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDO29CQUNwQyxJQUFJLEdBQUcsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ25CLElBQUksWUFBWSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7d0JBQ3ZFLElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQzt3QkFDcEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQzs0QkFDcEMsSUFBSSxHQUFHLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDOzRCQUNuQixJQUFJLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7Z0NBQ2xDLElBQUksT0FBTyxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO2dDQUN6QyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7b0NBQ1gsT0FBTyxHQUFHLElBQUEsdUJBQVksRUFBQyxHQUFHLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO29DQUMxQyxZQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0NBQ3hDLENBQUM7Z0NBQ0QsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO29DQUM3QixPQUFPLEdBQUcsSUFBSSxDQUFDO29DQUNmLE1BQU07Z0NBQ1YsQ0FBQzs0QkFDTCxDQUFDO3dCQUNMLENBQUM7d0JBQ0QsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDOzRCQUNYLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7d0JBQ3RCLENBQUM7b0JBQ0wsQ0FBQztnQkFDTCxDQUFDO2dCQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQ3hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxPQUFPLENBQUMsTUFBTSxVQUFVLENBQUMsQ0FBQztnQkFDMUMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztvQkFDdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7b0JBQzFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3RELENBQUM7Z0JBQ0QsV0FBVyxHQUFHLEtBQUssQ0FBQztZQUN4QixDQUFDO1NBQ0o7S0FDSixDQUFDO0FBQ04sQ0FBQztBQXBERCxrQ0FvREMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBc3NldEluZm8gfSBmcm9tIFwiQGNvY29zL2NyZWF0b3ItdHlwZXMvZWRpdG9yL3BhY2thZ2VzL2Fzc2V0LWRiL0B0eXBlcy9wdWJsaWNcIjtcclxuaW1wb3J0IHsgcmVhZEZpbGVTeW5jIH0gZnJvbSBcImZzLWV4dHJhXCI7XHJcblxyXG5jb25zdCBUYXJnZXRGaWx0ZXIgPSBbXCJjYy5JbWFnZUFzc2V0XCIsIFwiY2MuU3ByaXRlQXRsYXNcIiwgXCJjYy5BbmltYXRpb25DbGlwXCIsIFwiY2MuTWF0ZXJpYWxcIl07XHJcbmNvbnN0IFNlYXJjaEZpbHRlciA9IFtcImNjLlNjZW5lQXNzZXRcIiwgXCJjYy5QcmVmYWJcIl07XHJcblxyXG5sZXQgdXVpZDJCdWZmTWFwOiBNYXA8c3RyaW5nLCBzdHJpbmc+ID0gbmV3IE1hcCgpO1xyXG5sZXQgaXNTZWFyY2hpbmcgPSBmYWxzZTtcclxuLyoqXHJcbiAqIOS4jeiDveWumuS5ieS4umFzeW5j77yM5ZCm5YiZ5LiN55Sf5pWIXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gb25Bc3NldE1lbnUoYXNzZXRJbmZvOiBBc3NldEluZm8pOiBFZGl0b3IuTWVudS5CYXNlTWVudUl0ZW1bXSB7XHJcbiAgICBpZiAoIWFzc2V0SW5mby5pc0RpcmVjdG9yeSkgcmV0dXJuIFtdO1xyXG5cclxuICAgIHJldHVybiBbXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBsYWJlbDogXCLwn5SN5pyq6KKr5byV55So55qE6LWE5rqQXCIsXHJcbiAgICAgICAgICAgIGFzeW5jIGNsaWNrKCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGlzU2VhcmNoaW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCLmkJzntKLkuK3vvIzor7fnqI3nrYkuLi5cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaXNTZWFyY2hpbmcgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgRWRpdG9yLlNlbGVjdGlvbi5jbGVhcignYXNzZXQnKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwi5byA5aeL5pCc57SiID4+PlwiKTtcclxuXHJcbiAgICAgICAgICAgICAgICB1dWlkMkJ1ZmZNYXAuY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgIGxldCBpbmZvcyA9IGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ2Fzc2V0LWRiJywgJ3F1ZXJ5LWFzc2V0cycpO1xyXG4gICAgICAgICAgICAgICAgbGV0IHJlc3VsdHMgPSBbXTtcclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5mb3MubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgY3VyID0gaW5mb3NbaV07XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKFRhcmdldEZpbHRlci5pbmNsdWRlcyhjdXIudHlwZSkgJiYgY3VyLnVybC5zdGFydHNXaXRoKGFzc2V0SW5mby51cmwpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBoYXNGaW5kID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgaW5mb3MubGVuZ3RoOyArK2opIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBvbmUgPSBpbmZvc1tqXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChTZWFyY2hGaWx0ZXIuaW5jbHVkZXMob25lLnR5cGUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGNvbnRlbnQgPSB1dWlkMkJ1ZmZNYXAuZ2V0KG9uZS51dWlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbnRlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudCA9IHJlYWRGaWxlU3luYyhvbmUuZmlsZSwgJ3V0Zi04Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHV1aWQyQnVmZk1hcC5zZXQob25lLnV1aWQsIGNvbnRlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udGVudC5pbmNsdWRlcyhjdXIudXVpZCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzRmluZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWhhc0ZpbmQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChjdXIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwi5pCc57Si57uT5p2fIDw8PFwiKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGDmnIkke3Jlc3VsdHMubGVuZ3RofeS4qui1hOa6kOacquiiq+W8leeUqDpgKTtcclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzdWx0cy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke2kgKyAxfeOAgSR7cmVzdWx0c1tpXS51cmx9YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgRWRpdG9yLlNlbGVjdGlvbi5zZWxlY3QoJ2Fzc2V0JywgcmVzdWx0c1tpXS51dWlkKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlzU2VhcmNoaW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICBdO1xyXG59Il19